name: Zarch Hub Synchronization

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'Force sync all packages'
        required: false
        default: false
        type: boolean

env:
  REGISTRY_URL: "https://zenv-hub.onrender.com"
  SYNC_DIR: "zarch_sync"
  
jobs:
  sync-packages:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Setup Sync Environment
      run: |
        mkdir -p $SYNC_DIR
        mkdir -p $SYNC_DIR/packages
        
    - name: Authenticate with Zarch Hub
      env:
        ZARCH_TOKEN: ${{ secrets.ZARCH_TOKEN }}
        ZARCH_USERNAME: ${{ secrets.ZARCH_USERNAME }}
      run: |
        echo "Authenticating with Zarch Hub..."
        
        LOGIN_RESPONSE=$(curl -s -X POST "$REGISTRY_URL/api/auth/login" \
          -H "Content-Type: application/json" \
          -d "{\"username\": \"$ZARCH_USERNAME\", \"password\": \"$ZARCH_TOKEN\"}")
        
        TOKEN=$(echo $LOGIN_RESPONSE | jq -r '.token')
        echo "ZARCH_AUTH_TOKEN=$TOKEN" >> $GITHUB_ENV
        
        if [ -z "$TOKEN" ] || [ "$TOKEN" = "null" ]; then
          echo "Failed to authenticate with Zarch Hub"
          exit 1
        fi
        
        echo "✅ Successfully authenticated"
        
    - name: Fetch Package Index
      run: |
        echo "Fetching package index from Zarch Hub..."
        
        INDEX=$(curl -s "$REGISTRY_URL/zarch/INDEX")
        echo "$INDEX" > $SYNC_DIR/package_index.json
        
        PACKAGE_COUNT=$(echo "$INDEX" | jq -r '.total_packages')
        echo "Found $PACKAGE_COUNT packages"
        
        # Extract SwiftFlow packages
        echo "$INDEX" | jq -r '.packages | to_entries[] | select(.key | contains("swiftflow")) | .key' > $SYNC_DIR/swiftflow_packages.txt
        
    - name: Sync SwiftFlow Packages
      run: |
        echo "Syncing SwiftFlow packages..."
        
        while read -r package_name; do
          if [ -n "$package_name" ]; then
            echo "Processing package: $package_name"
            
            # Extract scope and name
            if [[ "$package_name" == @* ]]; then
              # Scoped package: @scope/name
              scope_name="${package_name#@}"
              scope="${scope_name%%/*}"
              name="${scope_name#*/}"
            else
              # Unscoped package
              scope="global"
              name="$package_name"
            fi
            
            # Get package info
            INFO=$(curl -s "$REGISTRY_URL/api/package/info/$scope/$name")
            VERSION=$(echo "$INFO" | jq -r '.latest_version')
            
            if [ -n "$VERSION" ] && [ "$VERSION" != "null" ]; then
              echo "Downloading $package_name v$VERSION..."
              
              # Download package
              curl -s -L "$REGISTRY_URL/package/download/$scope/$name/$VERSION" \
                -o "$SYNC_DIR/packages/${name}-${VERSION}.tar.gz"
                
              # Extract for inspection
              mkdir -p "$SYNC_DIR/extracted/${name}-${VERSION}"
              tar -xzf "$SYNC_DIR/packages/${name}-${VERSION}.tar.gz" \
                -C "$SYNC_DIR/extracted/${name}-${VERSION}"
                
              echo "✅ Synced $package_name v$VERSION"
            fi
          fi
        done < $SYNC_DIR/swiftflow_packages.txt
        
    - name: Update Package Documentation
      run: |
        echo "Updating package documentation..."
        
        # Create README with synced packages
        cat > $SYNC_DIR/README.md << 'EOF'
        # SwiftFlow Packages on Zarch Hub
        
        This directory contains packages synchronized from the Zarch Package Registry.
        
        ## Last Sync
        - **Date**: $(date)
        - **Registry**: $REGISTRY_URL
        - **Total Packages**: $(jq -r '.total_packages' $SYNC_DIR/package_index.json 2>/dev/null || echo "N/A")
        
        ## Available SwiftFlow Packages
        
        EOF
        
        # Add package list
        if [ -f "$SYNC_DIR/swiftflow_packages.txt" ]; then
          echo "" >> $SYNC_DIR/README.md
          echo "### SwiftFlow Packages" >> $SYNC_DIR/README.md
          echo "" >> $SYNC_DIR/README.md
          
          while read -r package_name; do
            if [ -n "$package_name" ]; then
              echo "- **$package_name**" >> $SYNC_DIR/README.md
            fi
          done < $SYNC_DIR/swiftflow_packages.txt
        fi
        
        echo "" >> $SYNC_DIR/README.md
        echo "## Usage" >> $SYNC_DIR/README.md
        echo "" >> $SYNC_DIR/README.md
        echo '```bash' >> $SYNC_DIR/README.md
        echo '# Install from Zarch Hub' >> $SYNC_DIR/README.md
        echo 'zarch install <package-name>' >> $SYNC_DIR/README.md
        echo "" >> $SYNC_DIR/README.md
        echo '# Or use SwiftFlow directly' >> $SYNC_DIR/README.md
        echo 'import "package" from "scope";' >> $SYNC_DIR/README.md
        echo '```' >> $SYNC_DIR/README.md
        
    - name: Upload Sync Results
      uses: actions/upload-artifact@v4
      with:
        name: zarch-sync-$(date +%Y%m%d-%H%M%S)
        path: $SYNC_DIR/
        retention-days: 30
        
    - name: Update Repository Files
      if: github.ref == 'refs/heads/main'
      run: |
        echo "Updating repository files..."
        
        # Update package list in docs
        mkdir -p docs/zarch
        cp $SYNC_DIR/package_index.json docs/zarch/
        cp $SYNC_DIR/README.md docs/zarch/SYNC.md
        
        # Update badge in main README
        PACKAGE_COUNT=$(jq -r '.total_packages' $SYNC_DIR/package_index.json 2>/dev/null || echo "0")
        
        # Create stats file
        cat > docs/zarch/STATS.md << EOF
        # Zarch Hub Statistics
        
        ## Current Status
        - **Total Packages**: $PACKAGE_COUNT
        - **Last Sync**: $(date)
        - **Registry URL**: $REGISTRY_URL
        
        ## SwiftFlow Integration
        - **SwiftFlow Packages**: $(wc -l < $SYNC_DIR/swiftflow_packages.txt 2>/dev/null || echo "0")
        - **SwiftFlow Version**: $(./swiftflow --version 2>/dev/null || echo "Unknown")
        
        ## Sync Frequency
        - **Automatic**: Every 6 hours
        - **Manual**: Via workflow_dispatch
        EOF
        
    - name: Create Sync Report
      run: |
        echo "## Zarch Hub Sync Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Sync completed at**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Statistics" >> $GITHUB_STEP_SUMMARY
        echo "- Total packages in registry: $(jq -r '.total_packages' $SYNC_DIR/package_index.json 2>/dev/null || echo "N/A")" >> $GITHUB_STEP_SUMMARY
        echo "- SwiftFlow packages synced: $(wc -l < $SYNC_DIR/swiftflow_packages.txt 2>/dev/null || echo "0")" >> $GITHUB_STEP_SUMMARY
        echo "- Sync directory: $SYNC_DIR/" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "1. Review synced packages in artifacts" >> $GITHUB_STEP_SUMMARY
        echo "2. Update documentation if needed" >> $GITHUB_STEP_SUMMARY
        echo "3. Test package installation" >> $GITHUB_STEP_SUMMARY
