name: Auto Deploy to Zarch Hub

on:
  push:
    branches: [main]
    paths:
      - 'packages/**'
      - 'Makefile'
      - '*.c'
      - '*.h'

jobs:
  auto-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Build and Package
      run: |
        make clean
        make
        
        # Create package version
        VERSION=$(date +%Y.%m.%d-%H%M)
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        
        # Create package directory
        mkdir -p deploy
        cp swiftflow deploy/
        cp -r examples deploy/
        
        # Create manifest
        cat > deploy/zarch.json << EOF
        {
          "name": "swiftflow",
          "version": "$VERSION",
          "description": "Auto-deployed SwiftFlow build",
          "main": "swiftflow",
          "author": "GoPU.inc CI",
          "license": "MIT",
          "scope": "global",
          "git_commit": "${{ github.sha }}",
          "build_date": "$(date -Iseconds)"
        }
        EOF
        
        # Create archive
        cd deploy
        tar -czf ../swiftflow-$VERSION.tar.gz .
        
    - name: Deploy to Zarch Hub
        env: 
        ZARCH_TOKEN: ${{ secrets.ZARCH_TOKEN }}
        ZARCH_USERNAME: ${{ secrets.ZARCH_USERNAME }}
        ZARCH_PERSONAL_CODE: ${{ secrets.ZARCH_PERSONAL_CODE }}
